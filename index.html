<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=720, height=1280, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VTB Terminal</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 720px;
            height: 1280px;
            overflow: hidden;
            position: fixed;
            font-family: Arial, sans-serif;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .screen.active {
            display: block;
        }

        .background {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .terminal-number {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 16px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
        }

        .payment-amount {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .facepay-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 100;
        }

        .facepay-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <!-- Экран ожидания -->
    <div id="idle-screen" class="screen active">
        <img src="https://pablo-chitaksa.github.io/vtbterm/resources/idle.jpg" alt="Idle Screen" class="background">
        <div class="terminal-number">Номер терминала: <span id="terminal-num">1</span></div>
    </div>

    <!-- Экран оплаты -->
    <div id="paying-screen" class="screen">
        <img src="https://pablo-chitaksa.github.io/vtbterm/resources/paying.jpg" alt="Paying Screen" class="background">
        <div class="payment-amount" id="payment-amount"></div>
        <div class="facepay-button" onclick="handleFacePay()">
            <img src="https://pablo-chitaksa.github.io/vtbterm/resources/facepay.jpg" alt="Face Pay">
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://vtb-term-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let terminalNumber = 1;
        let currentState = "TERM_IS_IDLE";
        let currentPaymentAmount = "Null";

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Get terminal number from Android or generate
            if (typeof Android !== 'undefined' && Android.getTerminalNumber) {
                terminalNumber = Android.getTerminalNumber();
            } else {
                terminalNumber = Math.floor(Math.random() * 100) + 1;
            }
            
            document.getElementById('terminal-num').textContent = terminalNumber;
            
            // Write initial state to Firebase
            writeToFirebase("TERM_IS_IDLE", "Null");
            
            // Start listening for changes
            setupFirebaseListener();
        });

        function writeToFirebase(state, paying) {
            const terminalRef = database.ref('termnumbers/user' + terminalNumber);
            
            terminalRef.set({
                State: state,
                Paying: paying,
                linked: 'false'
            }).then(() => {
                console.log('Data written to Firebase');
            }).catch((error) => {
                console.error('Error writing to Firebase:', error);
            });
        }

        function setupFirebaseListener() {
            const terminalRef = database.ref('termnumbers/user' + terminalNumber);
            
            terminalRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const newState = data.State || "TERM_IS_IDLE";
                    const newPaying = data.Paying || "Null";
                    
                    if (newState === "TERM_IS_PAYING" && newPaying !== "Null") {
                        switchToPayingScreen(newPaying);
                    } else if (newState === "TERM_IS_IDLE") {
                        switchToIdleScreen();
                    }
                }
            });
        }

        function switchToPayingScreen(amount) {
            document.getElementById('idle-screen').classList.remove('active');
            document.getElementById('paying-screen').classList.add('active');
            
            const formattedAmount = parseInt(amount).toLocaleString('ru-RU') + ' руб.';
            document.getElementById('payment-amount').textContent = formattedAmount;
            
            currentState = "TERM_IS_PAYING";
            currentPaymentAmount = amount;
        }

        function switchToIdleScreen() {
            document.getElementById('paying-screen').classList.remove('active');
            document.getElementById('idle-screen').classList.add('active');
            
            currentState = "TERM_IS_IDLE";
            currentPaymentAmount = "Null";
        }

        function handleFacePay() {
            if (currentState === "TERM_IS_PAYING") {
                alert('Оплата FacePay: ' + currentPaymentAmount + ' руб.');
                // Здесь можно добавить логику обработки оплаты
                
                // После оплаты возвращаем в idle режим
                writeToFirebase("TERM_IS_IDLE", "Null");
            }
        }

        // Обработка нажатий для перехода (как в Python версии)
        let pressCount = 0;
        document.getElementById('idle-screen').addEventListener('click', function(e) {
            if (e.target.classList.contains('background')) {
                pressCount++;
                
                if (pressCount >= 5) {
                    // Имитация перехода в режим оплаты для тестирования
                    const testAmount = Math.floor(Math.random() * 10000) + 100;
                    writeToFirebase("TERM_IS_PAYING", testAmount.toString());
                    pressCount = 0;
                }
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            writeToFirebase("TERM_IS_OFFLINE", "Null");
        });
    </script>
</body>
</html>
